<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERAIF Demo - Emergency Radiology AI Interoperability Framework</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .demo-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .demo-section:hover {
            transform: translateY(-5px);
        }

        .demo-section h2 {
            color: #2a5298;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: #2a5298;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3c72;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .status-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-display {
            background: #000;
            color: #00ff00;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .hospital-node {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .hospital-node.emergency {
            background: #ffebee;
            border-color: #f44336;
            animation: pulse 2s infinite;
        }

        .hospital-node.disaster {
            background: #fff3e0;
            border-color: #ff9800;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .message-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® ERAIF Demo</h1>
            <p>Emergency Radiology AI Interoperability Framework</p>
        </div>

        <div class="demo-grid">
            <!-- Network Status Section -->
            <div class="demo-section">
                <h2>üè• Network Status</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="totalNodes">0</div>
                        <div class="metric-label">Total Nodes</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="emergencyStatus">No</div>
                        <div class="metric-label">Emergency Active</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalMessages">0</div>
                        <div class="metric-label">Messages Sent</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="cacheSize">0</div>
                        <div class="metric-label">Cache Size</div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="initializeNetwork()">Initialize Network</button>
                    <button class="btn btn-success" onclick="addHospital()">Add Hospital</button>
                    <button class="btn btn-warning" onclick="simulateMassCasualty()">Mass Casualty Event</button>
                    <button class="btn btn-danger" onclick="simulateDisaster()">Disaster Mode</button>
                </div>

                <div id="networkStatus" class="status-display">
                    Network not initialized. Click "Initialize Network" to start.
                </div>
            </div>

            <!-- Hospital Nodes Section -->
            <div class="demo-section">
                <h2>üè• Hospital Nodes</h2>
                <div id="hospitalNodes">
                    <p>No hospitals registered yet.</p>
                </div>
            </div>
        </div>

        <!-- Message Handling Section -->
        <div class="demo-section full-width">
            <h2>üì® Message Handling</h2>
            
            <div class="message-form">
                <div class="form-group">
                    <label for="messageType">Message Type:</label>
                    <select id="messageType">
                        <option value="image_request">Image Request</option>
                        <option value="emergency_alert">Emergency Alert</option>
                        <option value="status_check">Status Check</option>
                        <option value="handshake">Handshake</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="priority">Priority:</label>
                    <select id="priority">
                        <option value="ROUTINE">Routine</option>
                        <option value="URGENT">Urgent</option>
                        <option value="STAT">Stat</option>
                        <option value="CRITICAL">Critical</option>
                        <option value="LIFE_THREATENING">Life Threatening</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="sourceNode">Source Node:</label>
                    <select id="sourceNode"></select>
                </div>
                
                <div class="form-group">
                    <label for="destinationNode">Destination Node:</label>
                    <select id="destinationNode"></select>
                </div>
                
                <div class="form-group">
                    <label for="messagePayload">Payload (JSON):</label>
                    <textarea id="messagePayload" placeholder='{"patient_id": "12345", "modality": "CT", "body_part": "HEAD", "reason": "trauma"}'></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="sendMessage()">Send Message</button>
            </div>

            <div id="messageLog" class="log-display">
                Message log will appear here...
            </div>
        </div>

        <!-- Emergency Protocols Section -->
        <div class="demo-section full-width">
            <h2>üö® Emergency Protocols</h2>
            
            <div class="button-group">
                <button class="btn btn-warning" onclick="activateMassCasualty()">Activate Mass Casualty Mode</button>
                <button class="btn btn-danger" onclick="activateDisasterMode()">Activate Disaster Mode</button>
                <button class="btn btn-success" onclick="returnToNormal()">Return to Normal</button>
                <button class="btn btn-info" onclick="testFailover()">Test Failover Protocols</button>
            </div>

            <div id="emergencyLog" class="log-display">
                Emergency protocols log will appear here...
            </div>
        </div>

        <!-- System Logs Section -->
        <div class="demo-section full-width">
            <h2>üìã System Logs</h2>
            <div class="button-group">
                <button class="btn btn-info" onclick="clearLogs()">Clear Logs</button>
                <button class="btn btn-primary" onclick="exportLogs()">Export Logs</button>
            </div>
            <div id="systemLogs" class="log-display">
                System logs will appear here...
            </div>
        </div>
    </div>

    <script>
        // ERAIF System Implementation
        class ERAIFMessage {
            constructor(priority, messageType, payload, routing = {}) {
                this.version = "1.0";
                this.timestamp = new Date().toISOString();
                this.priority = priority;
                this.mode = "NORMAL";
                this.messageType = messageType;
                this.payload = payload;
                this.routing = routing;
                this.signature = this.generateSignature();
            }

            generateSignature() {
                const content = `${this.timestamp}${this.priority}${this.messageType}`;
                return btoa(content).substring(0, 16);
            }

            toJSON() {
                return {
                    version: this.version,
                    timestamp: this.timestamp,
                    priority: this.priority,
                    mode: this.mode,
                    messageType: this.messageType,
                    payload: this.payload,
                    routing: this.routing,
                    signature: this.signature
                };
            }
        }

        class ERAIFNode {
            constructor(nodeId, hospitalName) {
                this.nodeId = nodeId;
                this.hospitalName = hospitalName;
                this.mode = "NORMAL";
                this.connectedNodes = [];
                this.messageQueue = [];
                this.cachedData = {};
                this.messageCount = 0;
            }

            setMode(mode) {
                const oldMode = this.mode;
                this.mode = mode;
                logMessage(`MODE CHANGE: ${oldMode} -> ${mode}`, 'warning');
                
                if (mode === 'DISASTER') {
                    this.activateDisasterMode();
                } else if (mode === 'MASS_CASUALTY') {
                    this.activateMassCasualtyMode();
                }
            }

            activateDisasterMode() {
                logMessage(`DISASTER MODE ACTIVATED for ${this.hospitalName}`, 'danger');
                this.messageQueue = this.messageQueue.filter(msg => 
                    msg.priority === 'LIFE_THREATENING' || msg.priority === 'CRITICAL'
                );
            }

            activateMassCasualtyMode() {
                logMessage(`MASS CASUALTY MODE ACTIVATED for ${this.hospitalName}`, 'warning');
                this.messageQueue = this.messageQueue.filter(msg => 
                    msg.priority !== 'ROUTINE'
                );
            }

            sendMessage(message, destination) {
                try {
                    this.messageCount++;
                    if (this.mode === 'DISASTER') {
                        return this.sendDisasterMode(message, destination);
                    }
                    
                    logMessage(`Sending ${message.messageType} to ${destination}`, 'info');
                    return true;
                } catch (e) {
                    logMessage(`Failed to send message: ${e}`, 'danger');
                    this.messageQueue.push(message);
                    return false;
                }
            }

            sendDisasterMode(message, destination) {
                const paths = ['primary', 'p2p', 'satellite', 'cellular'];
                
                for (const path of paths) {
                    logMessage(`Attempting ${path} path to ${destination}`, 'info');
                    if (path === 'p2p') {
                        logMessage(`P2P path successful to ${destination}`, 'success');
                        return true;
                    }
                }
                return false;
            }

            receiveMessage(message) {
                logMessage(`Received ${message.messageType} priority=${message.priority}`, 'info');
                
                if (message.messageType === 'image_request') {
                    return this.handleImageRequest(message);
                } else if (message.messageType === 'emergency_alert') {
                    return this.handleEmergencyAlert(message);
                }
                
                return { status: 'processed' };
            }

            handleImageRequest(message) {
                const patientId = message.payload.patient_id;
                const modality = message.payload.modality;
                
                logMessage(`Image request: patient=${patientId}, modality=${modality}`, 'info');
                
                const cacheKey = `${patientId}_${modality}`;
                if (this.cachedData[cacheKey]) {
                    return {
                        status: 'success',
                        data: this.cachedData[cacheKey],
                        source: 'cache'
                    };
                }
                
                return {
                    status: 'pending',
                    estimated_time: 30
                };
            }

            handleEmergencyAlert(message) {
                const alertType = message.payload.alert_type;
                logMessage(`EMERGENCY ALERT: ${alertType}`, 'danger');
                
                if (alertType === 'mass_casualty') {
                    this.setMode('MASS_CASUALTY');
                } else if (alertType === 'infrastructure_failure') {
                    this.setMode('DISASTER');
                }
                
                return { status: 'alert_acknowledged' };
            }

            getStatus() {
                return {
                    nodeId: this.nodeId,
                    hospital: this.hospitalName,
                    mode: this.mode,
                    connectedNodes: this.connectedNodes.length,
                    queuedMessages: this.messageQueue.length,
                    cacheSize: Object.keys(this.cachedData).length,
                    messageCount: this.messageCount,
                    timestamp: new Date().toISOString()
                };
            }
        }

        class ERAIFNetwork {
            constructor() {
                this.nodes = {};
                this.emergencyStatus = false;
                this.totalMessages = 0;
            }

            registerNode(node) {
                this.nodes[node.nodeId] = node;
                logMessage(`Node registered: ${node.nodeId}`, 'success');
                
                for (const [otherId, otherNode] of Object.entries(this.nodes)) {
                    if (otherId !== node.nodeId) {
                        otherNode.connectedNodes.push(node.nodeId);
                    }
                }
                
                this.updateUI();
            }

            broadcastEmergency(emergencyType) {
                this.emergencyStatus = true;
                
                const alert = new ERAIFMessage(
                    'CRITICAL',
                    'emergency_alert',
                    { alert_type: emergencyType }
                );
                
                for (const node of Object.values(this.nodes)) {
                    node.receiveMessage(alert);
                }
                
                logMessage(`Emergency broadcast sent: ${emergencyType}`, 'danger');
                this.updateUI();
            }

            getNetworkStatus() {
                return {
                    totalNodes: Object.keys(this.nodes).length,
                    emergencyActive: this.emergencyStatus,
                    totalMessages: this.totalMessages,
                    nodes: Object.values(this.nodes).map(node => node.getStatus())
                };
            }

            updateUI() {
                this.updateMetrics();
                this.updateHospitalNodes();
                this.updateNodeSelects();
            }

            updateMetrics() {
                const status = this.getNetworkStatus();
                document.getElementById('totalNodes').textContent = status.totalNodes;
                document.getElementById('emergencyStatus').textContent = status.emergencyActive ? 'YES' : 'No';
                document.getElementById('totalMessages').textContent = status.totalMessages;
                
                let totalCache = 0;
                for (const node of Object.values(this.nodes)) {
                    totalCache += Object.keys(node.cachedData).length;
                }
                document.getElementById('cacheSize').textContent = totalCache;
            }

            updateHospitalNodes() {
                const container = document.getElementById('hospitalNodes');
                container.innerHTML = '';
                
                for (const [nodeId, node] of Object.entries(this.nodes)) {
                    const nodeDiv = document.createElement('div');
                    nodeDiv.className = `hospital-node ${node.mode.toLowerCase()}`;
                    
                    const status = node.getStatus();
                    nodeDiv.innerHTML = `
                        <h4>${status.hospital} (${status.nodeId})</h4>
                        <p><strong>Mode:</strong> ${status.mode}</p>
                        <p><strong>Connected Nodes:</strong> ${status.connectedNodes}</p>
                        <p><strong>Messages Sent:</strong> ${status.messageCount}</p>
                        <p><strong>Cache Size:</strong> ${status.cacheSize}</p>
                    `;
                    
                    container.appendChild(nodeDiv);
                }
            }

            updateNodeSelects() {
                const sourceSelect = document.getElementById('sourceNode');
                const destSelect = document.getElementById('destinationNode');
                
                sourceSelect.innerHTML = '';
                destSelect.innerHTML = '';
                
                for (const nodeId of Object.keys(this.nodes)) {
                    const sourceOption = document.createElement('option');
                    sourceOption.value = nodeId;
                    sourceOption.textContent = nodeId;
                    sourceSelect.appendChild(sourceOption);
                    
                    const destOption = document.createElement('option');
                    destOption.value = nodeId;
                    destOption.textContent = nodeId;
                    destSelect.appendChild(destOption);
                }
            }
        }

        // Global variables
        let network = null;
        let messageCounter = 0;

        // Utility functions
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            // Add to system logs
            const systemLogs = document.getElementById('systemLogs');
            systemLogs.innerHTML += logEntry + '\n';
            systemLogs.scrollTop = systemLogs.scrollHeight;
            
            // Add to appropriate log based on type
            if (type === 'emergency') {
                const emergencyLog = document.getElementById('emergencyLog');
                emergencyLog.innerHTML += logEntry + '\n';
                emergencyLog.scrollTop = emergencyLog.scrollHeight;
            } else if (type === 'message') {
                const messageLog = document.getElementById('messageLog');
                messageLog.innerHTML += logEntry + '\n';
                messageLog.scrollTop = messageLog.scrollHeight;
            }
        }

        // Network functions
        function initializeNetwork() {
            network = new ERAIFNetwork();
            
            // Create default hospitals
            const node1 = new ERAIFNode("HOSP001", "County General Hospital");
            const node2 = new ERAIFNode("HOSP002", "St. Mary's Medical Center");
            const node3 = new ERAIFNode("HOSP003", "Rural Community Hospital");
            
            network.registerNode(node1);
            network.registerNode(node2);
            network.registerNode(node3);
            
            document.getElementById('networkStatus').innerHTML = 'Network initialized with 3 hospitals.';
            logMessage('Network initialized successfully', 'success');
        }

        function addHospital() {
            if (!network) {
                alert('Please initialize the network first!');
                return;
            }
            
            const hospitalNames = [
                "Metropolitan Medical Center",
                "University Hospital",
                "Emergency Trauma Center",
                "Regional Medical Center",
                "Community Health Hospital"
            ];
            
            const randomName = hospitalNames[Math.floor(Math.random() * hospitalNames.length)];
            const nodeId = `HOSP${String(Object.keys(network.nodes).length + 1).padStart(3, '0')}`;
            
            const newNode = new ERAIFNode(nodeId, randomName);
            network.registerNode(newNode);
            
            logMessage(`Added new hospital: ${randomName} (${nodeId})`, 'success');
        }

        function simulateMassCasualty() {
            if (!network) {
                alert('Please initialize the network first!');
                return;
            }
            
            network.broadcastEmergency('mass_casualty');
            logMessage('Mass casualty event simulated across network', 'warning');
        }

        function simulateDisaster() {
            if (!network) {
                alert('Please initialize the network first!');
                return;
            }
            
            // Set random nodes to disaster mode
            const nodes = Object.values(network.nodes);
            const randomNode = nodes[Math.floor(Math.random() * nodes.length)];
            randomNode.setMode('DISASTER');
            
            logMessage(`Disaster mode activated for ${randomNode.hospitalName}`, 'danger');
        }

        function sendMessage() {
            if (!network) {
                alert('Please initialize the network first!');
                return;
            }
            
            const messageType = document.getElementById('messageType').value;
            const priority = document.getElementById('priority').value;
            const sourceNode = document.getElementById('sourceNode').value;
            const destinationNode = document.getElementById('destinationNode').value;
            const payloadText = document.getElementById('messagePayload').value;
            
            if (!sourceNode || !destinationNode) {
                alert('Please select source and destination nodes!');
                return;
            }
            
            let payload;
            try {
                payload = payloadText ? JSON.parse(payloadText) : {};
            } catch (e) {
                alert('Invalid JSON in payload!');
                return;
            }
            
            const message = new ERAIFMessage(
                priority,
                messageType,
                payload,
                {
                    source: sourceNode,
                    destination: destinationNode
                }
            );
            
            const sourceNodeObj = network.nodes[sourceNode];
            const destNodeObj = network.nodes[destinationNode];
            
            if (sourceNodeObj && destNodeObj) {
                sourceNodeObj.sendMessage(message, destinationNode);
                const response = destNodeObj.receiveMessage(message);
                
                logMessage(`Message sent from ${sourceNode} to ${destinationNode}`, 'message');
                logMessage(`Response: ${JSON.stringify(response)}`, 'message');
                
                network.totalMessages++;
                network.updateUI();
            }
        }

        function activateMassCasualty() {
            if (!network) {
                alert('Please initialize the network first!');
                return;
            }
            
            for (const node of Object.values(network.nodes)) {
                node.setMode('MASS_CASUALTY');
            }
            
            logMessage('Mass casualty mode activated for all nodes', 'warning');
            network.updateUI();
        }

        function activateDisasterMode() {
            if (!network) {
                alert('Please initialize the network first!');
                return;
            }
            
            for (const node of Object.values(network.nodes)) {
                node.setMode('DISASTER');
            }
            
            logMessage('Disaster mode activated for all nodes', 'danger');
            network.updateUI();
        }

        function returnToNormal() {
            if (!network) {
                alert('Please initialize the network first!');
                return;
            }
            
            for (const node of Object.values(network.nodes)) {
                node.setMode('NORMAL');
            }
            
            network.emergencyStatus = false;
            logMessage('All nodes returned to normal mode', 'success');
            network.updateUI();
        }

        function testFailover() {
            if (!network) {
                alert('Please initialize the network first!');
                return;
            }
            
            logMessage('Testing failover protocols...', 'info');
            
            // Simulate failover by sending messages in disaster mode
            const nodes = Object.values(network.nodes);
            const sourceNode = nodes[0];
            const destNode = nodes[1];
            
            sourceNode.setMode('DISASTER');
            
            const failoverMessage = new ERAIFMessage(
                'LIFE_THREATENING',
                'image_request',
                {
                    patient_id: 'FAILOVER_TEST',
                    modality: 'CT',
                    body_part: 'CHEST',
                    reason: 'failover_test'
                },
                {
                    source: sourceNode.nodeId,
                    destination: destNode.nodeId
                }
            );
            
            sourceNode.sendMessage(failoverMessage, destNode.nodeId);
            logMessage('Failover test completed', 'info');
        }

        function clearLogs() {
            document.getElementById('systemLogs').innerHTML = '';
            document.getElementById('messageLog').innerHTML = '';
            document.getElementById('emergencyLog').innerHTML = '';
            logMessage('All logs cleared', 'info');
        }

        function exportLogs() {
            const logs = {
                system: document.getElementById('systemLogs').innerText,
                messages: document.getElementById('messageLog').innerText,
                emergency: document.getElementById('emergencyLog').innerText,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(logs, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `eraif-logs-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            logMessage('Logs exported successfully', 'success');
        }

        // Initialize the demo
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('ERAIF Demo loaded successfully', 'success');
            logMessage('Click "Initialize Network" to start the demo', 'info');
        });
    </script>
</body>
</html>
